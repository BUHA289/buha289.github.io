### Entity ì¡°íšŒ

<aside> ğŸ“š `em.getReference()`ëŠ” JPAì˜ EntityManagerì—ì„œ ì œê³µí•˜ëŠ” ë©”ì„œë“œë¡œ íŠ¹ì • ì—”í‹°í‹°ì˜ í”„ë¡ì‹œ ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤. ì§€ì—° ë¡œë”©(Lazy Loading)ì„ í™œìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒë¥¼ ë¯¸ë£¨ê³  ì‹¤ì œë¡œ ì—”í‹°í‹°ì˜ ì†ì„±ì— ì ‘ê·¼í•  ë•Œë§Œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°íšŒí•˜ë„ë¡ í•œë‹¤.

</aside>

- **Entity ì¡°íšŒ**

  - **Entity**

    ```java
    @Entity
    @Table(name = "tutor")
    public class Tutor {
    
        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
        private Long id;
    
        private String name;
    
        @ManyToOne
        @JoinColumn(name = "company_id")
        private Company company;
    
        public Tutor() {
        }
    
        public Tutor(String name) {
            this.name = name;
        }
    
        public Long getId() {
            return id;
        }
    
        public String getName() {
            return name;
        }
        
        public Company getCompany() {
            return company;
        }
    
        public void setCompany(Company company) {
            this.company = company;
        }
    }
    ```

    ```java
    @Entity
    @Table(name = "company")
    public class Company {
    
        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
        private Long id;
    
        private String name;
    
        public Company() {
        }
    
        public Company(String name) {
            this.name = name;
        }
    
        public Long getId() {
            return id;
        }
    
        public String getName() {
            return name;
        }
    
    }
    ```

    - **Entity ì—°ê´€ê´€ê³„**

      ![img](https://teamsparta.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F83c75a39-3aba-4ba4-a792-7aefe4b07895%2F5d8b3042-282d-49fd-b637-39441ebfd9c2%2Fimage.png?table=block&id=475744ec-1ca9-4365-9776-cb18419043d6&spaceId=83c75a39-3aba-4ba4-a792-7aefe4b07895&width=770&userId=&cache=v2)

  ```java
  // 1. tutorì˜ companyë¥¼ í•¨ê»˜ ì¡°íšŒí•˜ëŠ” ê²½ìš°
  Tutor findTutor = em.find(Tutor.class, 1L);
  
  String tutorName = findTutor.getName();
  Company tutorCompany = findTutor.getCompany();
  
  System.out.println("tutorName = " + tutorName);
  System.out.println("tutorCompany.getName() = " + tutorCompany.getName());
  ```

  ```java
  // 2. tutorë§Œ ì¡°íšŒí•˜ëŠ” ê²½ìš°
  Tutor findTutor = em.find(Tutor.class, 1L);
  
  String tutorName = findTutor.getName();
  
  System.out.println("tutorName = " + tutorName);
  ```

  1. ```
     Tutor
     ```

     ë¥¼ ì¡°íšŒí•  ë•Œ 

     ```
     Company
     ```

      ë¥¼ í•¨ê»˜ ì¡°íšŒ

     - `Company`ë¥¼ ë§¤ë²ˆ í•¨ê»˜ ì¡°íšŒí•˜ëŠ”ê²ƒì€ ë‚­ë¹„ì´ë‹¤.

  2. ```
     Tutor
     ```

     ë§Œ ì¡°íšŒ

     - `Company` ì¡°íšŒë¥¼ ìœ„í•´ ì¶”ê°€ì ì¸ ì¡°íšŒ SQLì´ ì‹¤í–‰ë˜ì–´ì•¼ í•œë‹¤.

  - ì´ë•Œ **í”„ë¡ì‹œ**ë¥¼ ì‚¬ìš©í•˜ì—¬ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.

<aside> ğŸ’¡ `em.find()` ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í†µí•´ ì‹¤ì œë¡œ ì €ì¥ëœ Entity ë¥¼ ì¡°íšŒí•œë‹¤.

</aside>

- em.find() vs em.getReference()

  - `em.find()`

    ```java
    public class Main {
        public static void main(String[] args) {
            EntityManagerFactory emf = Persistence.createEntityManagerFactory("entity");
    
            EntityManager em = emf.createEntityManager();
    
            EntityTransaction transaction = em.getTransaction();
    
            transaction.begin();
    
            try {
    
                Tutor tutor = new Tutor("wonuk");
                em.persist(tutor);
    
                // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                em.flush();
                em.clear();
    
                // Entity ê°ì²´ ì¡°íšŒ
                Tutor findTutor = em.find(Tutor.class, tutor.getId());
    
                transaction.commit();
            } catch (Exception e) {
                transaction.rollback();
            } finally {
                em.close();
            }
    
            emf.close();
        }
    }
    ```

    - ì‹¤í–‰ê²°ê³¼

      ![img](https://teamsparta.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F83c75a39-3aba-4ba4-a792-7aefe4b07895%2Fe23163dc-ef1d-40a3-b211-79cc56103f4a%2Fimage.png?table=block&id=23918575-6bb2-41d1-987c-be57c4b6300d&spaceId=83c75a39-3aba-4ba4-a792-7aefe4b07895&width=380&userId=&cache=v2)

      - ì¡°íšŒ SQLì´ ì‹¤í–‰ëœë‹¤.

  - `em.getReference()`

    - ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ Entityê°€ ì•„ë‹Œ ê°€ì§œ Entity ê°ì²´ë¥¼ ì¡°íšŒí•œë‹¤.

    ```java
    Tutor proxyTutor = em.getReference(Tutor.class, tutor.getId());
    ```

    - ì‹¤í–‰ê²°ê³¼

      ![img](https://teamsparta.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F83c75a39-3aba-4ba4-a792-7aefe4b07895%2Fdc90a6af-d204-4ec7-98e3-64ced266121a%2Fimage.png?table=block&id=eda8a76c-06bb-4429-a9db-fee79e42f403&spaceId=83c75a39-3aba-4ba4-a792-7aefe4b07895&width=380&userId=&cache=v2)

      - ì¡°íšŒ SQLì´ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.

  - `proxyTutor.getName()`

    ```java
    System.out.println("proxyTutor.getName() = " + proxyTutor.getName());
    ```

    - ì‹¤í–‰ê²°ê³¼

      ![img](https://teamsparta.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F83c75a39-3aba-4ba4-a792-7aefe4b07895%2F598576a8-bb72-4c4d-afe0-61f57b5cc930%2Fimage.png?table=block&id=003bc7e6-b712-4c2c-bb43-eb48de1cd19c&spaceId=83c75a39-3aba-4ba4-a792-7aefe4b07895&width=380&userId=&cache=v2)

      - ì‹¤ì œ ê°’ì´ ì‚¬ìš©ë˜ëŠ” ì‹œì ì— SQL Queryê°€ ì‹¤í–‰ëœë‹¤.

  - `proxyTutor`

    ```java
    System.out.println("proxyTutor.getClass() = " + proxyTutor.getClass());
    ```

    - ì‹¤í–‰ê²°ê³¼

      ![img](https://teamsparta.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F83c75a39-3aba-4ba4-a792-7aefe4b07895%2Fff014860-ca8a-4f06-81b2-f5403eba7026%2Fimage.png?table=block&id=743201cd-cee2-4c85-b7d7-b019d19ee3af&spaceId=83c75a39-3aba-4ba4-a792-7aefe4b07895&width=380&userId=&cache=v2)

      - Hibernateê°€ ë§Œë“œëŠ” Proxy ê°ì²´

### Proxy

<aside> ğŸ“š JPAì—ì„œ ì—”í‹°í‹° ê°ì²´ì˜ ì§€ì—° ë¡œë”©(Lazy Loading)ì„ ì§€ì›í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ëŒ€ë¦¬ ê°ì²´ë¡œ ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°’ì„ ì½ì–´ì˜¤ì§€ ì•Šê³ ë„ ì—”í‹°í‹°ì˜ ì°¸ì¡°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

</aside>

- **Proxy ê°ì²´**

  ![img](https://teamsparta.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F83c75a39-3aba-4ba4-a792-7aefe4b07895%2Fb091859c-2a23-489e-b43e-d6e8a505a15c%2Fimage.png?table=block&id=b0af38b3-d552-417f-9e8a-e1ace5be5d5e&spaceId=83c75a39-3aba-4ba4-a792-7aefe4b07895&width=670&userId=&cache=v2)

  - ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒë¥¼ ì§€ì—°í•˜ëŠ” ê°€ì§œ(Proxy) ê°ì²´ë¥¼ ì¡°íšŒí•œë‹¤.
    - ì‹¤ì œ Entityì™€ `==` ë¹„êµ ì‹¤íŒ¨, `instanceof` ì‚¬ìš©
  - `target` : ì§„ì§œ ê°ì²´ì˜ ì°¸ì¡°ë¥¼ ë³´ê´€í•œë‹¤.

  ![img](https://teamsparta.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F83c75a39-3aba-4ba4-a792-7aefe4b07895%2F3fefe4c1-d3da-430f-a1ae-31468491b3d1%2Fimage.png?table=block&id=fdc7f5e8-a92e-4be3-af50-7d1c151b714e&spaceId=83c75a39-3aba-4ba4-a792-7aefe4b07895&width=260&userId=&cache=v2)

  - ì‹¤ì œ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì•„ì„œ ë§Œë“¤ì–´ì§„ë‹¤.

- **Proxy ê°ì²´ ì´ˆê¸°í™”**

  ![img](https://teamsparta.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F83c75a39-3aba-4ba4-a792-7aefe4b07895%2F85163565-70f7-40ed-baee-c8168ec7db89%2Fimage.png?table=block&id=2bff4599-8f95-4f42-9f42-681d5c3e6048&spaceId=83c75a39-3aba-4ba4-a792-7aefe4b07895&width=580&userId=&cache=v2)

  1. `em.getReference()` : í”„ë¡ì‹œ ê°ì²´ ì¡°íšŒ
  2. `getName()`  : í”„ë¡ì‹œ ê°ì²´ì˜ `getName()` í˜¸ì¶œ
  3. JPAê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— `target` ì´ˆê¸°í™” ìš”ì²­
  4. ì‹¤ì œ DB ì¡°íšŒ
  5. Entity ìƒì„±
  6. `target`ì˜ `getName()` í˜¸ì¶œ

- **Proxy íŠ¹ì§•**

  - ìµœì´ˆë¡œ ì‚¬ìš©(ì‹¤ì œ Entityì— ì ‘ê·¼)í•  ë•Œ í•œ ë²ˆë§Œ ì´ˆê¸°í™”ëœë‹¤.

  - í”„ë¡ì‹œ ê°ì²´ë¥¼ í†µí•´ ì‹¤ì œ Entityì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

  - `em.getReference()` í˜¸ì¶œ ì‹œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— Entityê°€ ì¡´ì¬í•˜ë©´ ì‹¤ì œ Entityê°€ ë°˜í™˜ëœë‹¤.

  - ì¤€ì˜ì† ìƒíƒœì—ì„œ í”„ë¡ì‹œë¥¼ ì´ˆê¸°í™”í•˜ë©´ `LazyInitializationException` ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.

    ```java
    Tutor proxyTutor = em.getReference(Tutor.class, tutor.getId());
    System.out.println("proxyTutor.getClass() = " + proxyTutor.getClass());
    
    // ì¤€ì˜ì† ìƒíƒœ
    em.detach(proxyTutor);
    
    proxyTutor.getName();
    ```

    - ì‹¤í–‰ê²°ê³¼

      ![img](https://teamsparta.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F83c75a39-3aba-4ba4-a792-7aefe4b07895%2F74851546-4c60-434b-a98d-dea0fbe2d455%2Fimage.png?table=block&id=d6f4a81a-67a8-41e4-8273-ebd607f1737e&spaceId=83c75a39-3aba-4ba4-a792-7aefe4b07895&width=580&userId=&cache=v2)

      - `detach()` : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ”ë‹¤.
      - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ í†µí•´ ë„ì›€ì„ ë°›ì•„ì•¼ë§Œ ì‹¤ì œ Entityì— ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤.
      - ì‹¤ì œ JPA ê°œë°œì—ì„œ ê°€ì¥ ë§ì´ ë§ˆì£¼ì¹˜ëŠ” `Exception`



==

ì¶”ê°€ ì„¤ëª… êµ¬ì¡°

í”„ë¡ì‹œ(Proxy)ëŠ” JPAì—ì„œ **ì§€ì—° ë¡œë”©(Lazy Loading)**ì„ êµ¬í˜„í•˜ê¸° ìœ„í•œ í•µì‹¬ ê¸°ìˆ ë¡œ, em.getReference()` ë©”ì„œë“œë¥¼ í†µí•´ **í”„ë¡ì‹œ ê°ì²´ë¥¼ ë°˜í™˜**ë°›ì•„, ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ì‹œì ì„ **ìµœëŒ€í•œ ë’¤ë¡œ ë¯¸ë£¨ëŠ”** ë°©ì‹ìœ¼ë¡œ ì„±ëŠ¥ì„ ìµœì í™”í•œë‹¤. 

ê°œë…ê³¼ ë™ì‘ íë¦„, íŠ¹ì§•  - ì¢…í•© ì •ë¦¬

### 1. í”„ë¡ì‹œ(Proxy)ë€?

> í”„ë¡ì‹œëŠ” **ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ ëŒ€ì‹  ì‚¬ìš©ë˜ëŠ” ëŒ€ë¦¬ ê°ì²´**

- JPAì—ì„œ í”„ë¡ì‹œëŠ” ì—”í‹°í‹° í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ì•„ ë§Œë“¤ì–´ì§€ë©°, ì‹¤ì œ ë°ì´í„°ê°€ í•„ìš”í•œ ì‹œì ê¹Œì§€ **DB ì ‘ê·¼ì„ ì§€ì—°**ì‹œí‚¨ë‹¤
- `getReference()` í˜¸ì¶œ ì‹œ, **ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°íšŒí•˜ì§€ ì•Šê³ ë„** ì—”í‹°í‹°ì˜ ì°¸ì¡°ë¥¼ ì–»ëŠ”ë‹¤

```java

Tutor proxyTutor = em.getReference(Tutor.class, id);  // SQL ì‹¤í–‰ ì•ˆ ë¨
```

------

###  2. í”„ë¡ì‹œì˜ ë™ì‘ ì›ë¦¬

1. `em.getReference()`ë¡œ í”„ë¡ì‹œ ê°ì²´ ìƒì„± (Hibernateê°€ ë‚´ë¶€ì ìœ¼ë¡œ ByteBuddy ë“±ìœ¼ë¡œ ìƒì„±)
2. í”„ë¡ì‹œ ê°ì²´ëŠ” ì§„ì§œ ê°ì²´(`target`)ì— ëŒ€í•œ ì°¸ì¡°ë¥¼ ë‚´ë¶€ì— ë³´ê´€
3. ì‹¤ì œ í•„ë“œ ì ‘ê·¼ ì‹œ(`proxyTutor.getName()` ë“±) **ê·¸ì œì•¼ DB ì¡°íšŒë¥¼ ìˆ˜í–‰**
4. DBì—ì„œ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•œ í›„ **target ê°ì²´ë¡œ ì´ˆê¸°í™”**
5. ì´í›„ì˜ ëª¨ë“  í˜¸ì¶œì€ ì‹¤ì œ ê°ì²´ë¥¼ í†µí•´ ì²˜ë¦¬

**ìµœì´ˆ í•œ ë²ˆë§Œ ì´ˆê¸°í™”**ë˜ë©°, ê·¸ ì´í›„ì—ëŠ” ì¼ë°˜ ê°ì²´ì²˜ëŸ¼ ë™ì‘í•¨

------

###  3. í”„ë¡ì‹œ vs ì‹¤ ì—”í‹°í‹° ë¹„êµ



| êµ¬ë¶„         | `em.find()` | `em.getReference()`                 |
| ------------ | ----------- | ----------------------------------- |
| ë°˜í™˜ ê°ì²´    | ì‹¤ì œ ì—”í‹°í‹° | í”„ë¡ì‹œ ê°ì²´                         |
| DB ì ‘ê·¼ ì‹œì  | ì¦‰ì‹œ        | í•„ë“œ ì ‘ê·¼ ì‹œ                        |
| íƒ€ì…         | `Tutor`     | `com.example.Tutor$$HibernateProxy` |
| `==` ë¹„êµ    | true        | false (í”„ë¡ì‹œëŠ” ë‹¤ë¦„)               |
| `instanceof` | true        | true (í”„ë¡ì‹œëŠ” ì„œë¸Œí´ë˜ìŠ¤)          |

```java
Tutor realTutor = em.find(Tutor.class, id);
Tutor proxyTutor = em.getReference(Tutor.class, id);

System.out.println(realTutor == proxyTutor);        // false
System.out.println(proxyTutor instanceof Tutor);    // true
```

------

### 4. í”„ë¡ì‹œì˜ ì£¼ì˜ì 

#### ğŸ”¸ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ ì‚¬ìš©í•´ì•¼ í•¨

- í”„ë¡ì‹œëŠ” **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ê´€ë¦¬ ì¤‘ì¼ ë•Œë§Œ** ë‚´ë¶€ì ìœ¼ë¡œ ì´ˆê¸°í™”ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŒ
- `detach()` ë˜ëŠ” íŠ¸ëœì­ì…˜ì´ ëë‚œ í›„ì—ëŠ” `LazyInitializationException` ë°œìƒ

```
javaë³µì‚¬í¸ì§‘em.detach(proxyTutor);      // ì¤€ì˜ì† ìƒíƒœ
proxyTutor.getName();       // âŒ LazyInitializationException
```

#### ğŸ”¸ `==` ì—°ì‚° ì‚¬ìš© ê¸ˆì§€

- `proxy != real entity`ì¼ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë™ë“±ì„± ë¹„êµ ì‹œ **`equals()`** ë˜ëŠ” `id ë¹„êµ`ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨

#### ğŸ”¸ ì‚¬ìš© ì‹œì  ì£¼ì˜

- Service ê³„ì¸µì„ ë²—ì–´ë‚˜ Controllerë‚˜ Viewì—ì„œ Lazy í•„ë“œë¥¼ ì‚¬ìš©í•˜ë ¤ í•˜ë©´, í”„ë¡ì‹œê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì˜ˆì™¸ê°€ ë°œìƒí•¨ â†’ **DTO ë³€í™˜ ë˜ëŠ” ì´ˆê¸°í™” í•„ìš”**

------

###  5. í”„ë¡ì‹œ ì´ˆê¸°í™” ì—¬ë¶€ í™•ì¸

```java
PersistenceUnitUtil util = emf.getPersistenceUnitUtil();
boolean isLoaded = util.isLoaded(proxyTutor);  // ì´ˆê¸°í™” ì—¬ë¶€ í™•ì¸
```

------

###    ìš”ì•½

> **í”„ë¡ì‹œ(Proxy)ëŠ” ì§€ì—° ë¡œë”©ì„ í†µí•´ ì„±ëŠ¥ì„ ìµœì í™”í•˜ëŠ” Hibernateì˜ ëŒ€ë¦¬ ê°ì²´ë¡œ, ì‹¤ì œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‹œì ê¹Œì§€ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ì„ ìœ ë³´í•œë‹¤**
>**&&**
> **í•˜ì§€ë§Œ í”„ë¡ì‹œëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ë°€ì ‘í•˜ê²Œ ì—°ê´€ë˜ì–´ ìˆì–´, ì¤€ì˜ì† ìƒíƒœì—ì„œ ì ‘ê·¼í•˜ë©´ LazyInitializationExceptionì´ ë°œìƒí•˜ë©°, ë”°ë¼ì„œ ì‹ ì¤‘í•˜ê²Œ ì‚¬ìš©í•´ì•¼í•¨**
